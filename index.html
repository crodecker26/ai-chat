<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Partner Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 500px;
    margin: 40px auto;
    padding: 10px;
    transition: background 0.3s, color 0.3s;
  }
  body.light { background: #f5f5f5; color: #222; }
  body.dark { background: #222; color: #f5f5f5; }

  #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; border-radius: 10px; }
  .user { color: blue; margin: 5px 0; }
  .partner { color: green; margin: 5px 0; }
  .typing { font-style: italic; color: gray; }
  .message { margin: 5px 0; padding: 5px 10px; border-radius: 8px; display: inline-block; max-width: 80%; }
  .user .message { background: #d0e7ff; }
  .partner .message { background: #d0ffd6; }

  textarea { width: 100%; height: 60px; border-radius: 5px; }
  button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; }

  .controls { display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; }
</style>
</head>
<body class="light">

<h2>AI Partner Chat</h2>

<div class="controls">
  <button id="toggleTheme">Toggle Light/Dark</button>
  <button id="clearChat">Clear Chat</button>
  <label><input type="checkbox" id="soundToggle" checked> Sound</label>
</div>

<div id="chat"></div>

<textarea id="messageInput" placeholder="Type your message..."></textarea>
<button onclick="sendMessage()">Send</button>

<audio id="typeSound" src="type-sound.mp3" preload="auto"></audio>

<script>
const chatDiv = document.getElementById("chat");
const soundToggle = document.getElementById("soundToggle");
const typeSound = document.getElementById("typeSound");

// Assign random user ID
const userId = "user_" + Math.floor(Math.random() * 1000000);

// Load memory from localStorage
let memory = localStorage.getItem(userId) || "";
function saveMemory() { localStorage.setItem(userId, memory); }
function summarizeMemory(mem) { return mem.slice(-1000); } // last 1000 chars

function addMessage(text, sender) {
  const div = document.createElement("div");
  div.className = sender;
  const msgSpan = document.createElement("span");
  msgSpan.textContent = text;
  div.appendChild(msgSpan);
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function showTypingIndicator() {
  const div = document.createElement("div");
  div.id = "typingIndicator";
  div.className = "typing";
  div.textContent = "Your partner is typing...";
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById("typingIndicator");
  if (indicator) indicator.remove();
}

async function sendMessage() {
  const input = document.getElementById("messageInput");
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  addMessage("You: " + msg, "user");
  memory += `User: ${msg}\n`;
  saveMemory();
  showTypingIndicator();

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbykU-IpRnr7_ZkU19QdliBelXFsnM_0wTlYT031_JUI1jHh5U1Zm7BbgM66mmytSX8g/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        message: msg,
        memory: summarizeMemory(memory),
        timestamp: new Date().toISOString()
      })
    });

    if (!response.ok) throw new Error("Network response not OK: " + response.status);

    const data = await response.json();
    hideTypingIndicator();

    if (!data.ai_reply) throw new Error("No ai_reply returned from server");

    const partnerText = data.ai_reply;
    memory += `Partner: ${partnerText}\n`;
    saveMemory();

    // Animate partner typing letter by letter
    let index = 0;
    const partnerDiv = document.createElement("div");
    partnerDiv.className = "partner message";
    chatDiv.appendChild(partnerDiv);

    function typeLetter() {
      if (index < partnerText.length) {
        partnerDiv.textContent = partnerText.slice(0, index + 1);
        chatDiv.scrollTop = chatDiv.scrollHeight;
        if (soundToggle.checked) typeSound.play();
        index++;
        setTimeout(typeLetter, 50);
      }
    }
    typeLetter();

  } catch (e) {
    hideTypingIndicator();
    addMessage("⚠️ Error contacting Partner: " + e.message, "partner");
    console.error("sendMessage error:", e);
  }
}

// Light/Dark toggle
document.getElementById("toggleTheme").onclick = () => {
  document.body.classList.toggle("light");
  document.body.classList.toggle("dark");
};

// Clear chat and memory
document.getElementById("clearChat").onclick = () => {
  chatDiv.innerHTML = "";
  memory = "";
  saveMemory();
};
</script>

</body>
</html>
