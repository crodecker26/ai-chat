<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Partner Chat (Animated + Timestamps)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 40px auto;
    padding: 10px;
    background: #f7f7f7;
  }
  h2 {
    text-align: center;
    color: #333;
  }
  #chat {
    border: 1px solid #ccc;
    border-radius: 10px;
    min-height: 350px;
    padding: 15px;
    background: #fff;
    overflow-y: auto;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 10px;
  }
  .message {
    margin: 8px 0;
    padding: 10px 15px;
    border-radius: 20px;
    max-width: 80%;
    word-wrap: break-word;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    position: relative;
  }
  .message.show {
    opacity: 1;
    transform: translateY(0);
  }
  .user {
    background: #d0e7ff;
    color: #003366;
    margin-left: auto;
    text-align: right;
  }
  .ai {
    background: #e0ffe0;
    color: #006600;
    margin-right: auto;
    text-align: left;
  }
  .timestamp {
    font-size: 10px;
    color: #666;
    margin-top: 2px;
  }
  #typingIndicator {
    font-style: italic;
    color: #555;
    margin-bottom: 5px;
  }
  textarea {
    width: 100%;
    height: 60px;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    resize: none;
    font-size: 14px;
  }
  button {
    width: 100%;
    padding: 12px;
    margin-top: 5px;
    border-radius: 10px;
    border: none;
    background: #333;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background: #555;
  }
</style>
</head>
<body>

<h2>AI Partner Chat</h2>

<div id="chat"></div>
<div id="typingIndicator" style="display:none;">Your partner is typing<span id="dots"></span></div>

<textarea id="messageInput" placeholder="Type your message..."></textarea>
<button onclick="sendMessage()">Send</button>
<button onclick="clearMemory()">Reset Chat</button>

<script>
const MAX_MEMORY_LINES = 10;

// Auto-generate unique user ID per visitor
let userId = localStorage.getItem("ai_chat_user_id");
if (!userId) {
  userId = "user_" + Math.random().toString(36).substr(2, 9);
  localStorage.setItem("ai_chat_user_id", userId);
}

const MEMORY_KEY = "ai_chat_memory_" + userId;
let memory = localStorage.getItem(MEMORY_KEY) || "";

// Display existing memory
const chatDiv = document.getElementById("chat");
if (memory) {
  memory.split("\n").forEach(line => {
    if (line.startsWith("User:")) addMessage(line, "user", true);
    else if (line.startsWith("AI:")) addMessage(line, "ai", true);
  });
}

// Add message with animation and timestamp
function addMessage(text, sender, instant=false) {
  const div = document.createElement("div");
  div.className = "message " + sender;
  div.textContent = text;

  const timestamp = document.createElement("div");
  timestamp.className = "timestamp";
  const now = new Date();
  timestamp.textContent = now.getHours().toString().padStart(2,'0') + ":" +
                            now.getMinutes().toString().padStart(2,'0');
  div.appendChild(timestamp);

  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;

  if (!instant) {
    setTimeout(() => div.classList.add("show"), 10);
  } else {
    div.classList.add("show");
  }
}

function summarizeMemory(mem) {
  const lines = mem.split("\n").filter(line => line.trim() !== "");
  const start = Math.max(0, lines.length - MAX_MEMORY_LINES * 2);
  return lines.slice(start).join("\n");
}

function saveMemory() {
  localStorage.setItem(MEMORY_KEY, memory);
}

function clearMemory() {
  memory = "";
  localStorage.removeItem(MEMORY_KEY);
  chatDiv.innerHTML = "";
}

// Typing animation
let dotsInterval;
function showTypingIndicator() {
  const indicator = document.getElementById("typingIndicator");
  const dotsSpan = document.getElementById("dots");
  indicator.style.display = "block";
  let dots = 0;
  dotsInterval = setInterval(() => {
    dots = (dots + 1) % 4;
    dotsSpan.textContent = ".".repeat(dots);
  }, 500);
}

function hideTypingIndicator() {
  clearInterval(dotsInterval);
  document.getElementById("typingIndicator").style.display = "none";
  document.getElementById("dots").textContent = "";
}

async function sendMessage() {
  const input = document.getElementById("messageInput");
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  addMessage("You: " + msg, "user");
  memory += `User: ${msg}\n`;

  const memorySummary = summarizeMemory(memory);

  showTypingIndicator();

  try {
    const response = await fetch("https://hooks.zapier.com/hooks/catch/25106599/uqb4hsa/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        message: msg,
        memory: memorySummary,
        timestamp: new Date().toISOString()
      })
    });

    const data = await response.json();

    hideTypingIndicator();
    addMessage("AI: " + data.ai_reply, "ai");
    memory += `AI: ${data.ai_reply}\n`;
    saveMemory();

  } catch (error) {
    hideTypingIndicator();
    addMessage("⚠️ Error contacting AI", "ai");
    console.error(error);
  }
}
</script>

</body>
</html>
