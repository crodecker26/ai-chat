<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Partner Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 500px;
    margin: 20px auto;
    padding: 10px;
    background-color: #f0f0f0;
    transition: background-color 0.3s, color 0.3s;
  }

  body.dark {
    background-color: #1e1e1e;
    color: #f0f0f0;
  }

  #chat {
    border-radius: 10px;
    background: #fff;
    height: 400px;
    overflow-y: auto;
    padding: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 10px;
  }

  body.dark #chat {
    background: #2c2c2c;
  }

  .message {
    display: flex;
    max-width: 80%;
    padding: 10px;
    border-radius: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    word-wrap: break-word;
  }

  .user {
    background: #007bff;
    color: #fff;
    margin-left: auto;
    border-bottom-right-radius: 0;
  }

  .partner {
    background: #e4e6eb;
    color: #000;
    margin-right: auto;
    border-bottom-left-radius: 0;
  }

  body.dark .partner {
    background: #3a3a3a;
    color: #fff;
  }

  .profile-pic {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    margin-right: 8px;
  }

  #inputArea {
    display: flex;
    gap: 5px;
  }

  textarea {
    flex: 1;
    height: 60px;
    border-radius: 10px;
    padding: 5px;
    resize: none;
  }

  button {
    padding: 10px;
    border-radius: 10px;
    cursor: pointer;
    border: none;
    background-color: #007bff;
    color: #fff;
  }

  .typing {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .dot {
    width: 8px;
    height: 8px;
    background: #666;
    border-radius: 50%;
    animation: bounce 0.6s infinite alternate;
  }

  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    to { transform: translateY(-5px); }
  }

  #controls {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<h2>AI Partner Chat</h2>

<div id="controls">
  <button id="clearBtn">Clear Chat</button>
  <button id="toggleTheme">Toggle Light/Dark</button>
  <button id="toggleSound">Toggle Sound</button>
</div>

<div id="chat"></div>

<div id="inputArea">
  <textarea id="msg" placeholder="Type your message..."></textarea>
  <button id="sendBtn">Send</button>
</div>

<audio id="sendSound" src="https://www.soundjay.com/button/sounds/button-16.mp3"></audio>

<script>
const chat = document.getElementById('chat');
const msgBox = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');
const toggleThemeBtn = document.getElementById('toggleTheme');
const toggleSoundBtn = document.getElementById('toggleSound');
const sendSound = document.getElementById('sendSound');

let soundEnabled = true;

// Generate a random user id per session
const userId = 'user_' + Math.random().toString(36).substr(2, 9);

// Simple in-memory conversation memory
let memory = [];

function addMessage(text, sender) {
  const div = document.createElement('div');
  div.className = `message ${sender}`;

  const pic = document.createElement('img');
  pic.className = 'profile-pic';
  pic.src = sender === 'user' 
            ? 'https://i.pravatar.cc/36?img=3' 
            : 'https://i.pravatar.cc/36?img=5';

  div.appendChild(pic);
  const span = document.createElement('span');
  span.textContent = text;
  div.appendChild(span);

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
  const div = document.createElement('div');
  div.className = 'message partner typing';
  div.id = 'typingIndicator';
  div.innerHTML = '<img class="profile-pic" src="https://i.pravatar.cc/36?img=5"><span><div class="dot"></div><div class="dot"></div><div class="dot"></div></span>';
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function hideTyping() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) indicator.remove();
}

async function sendMessage() {
  const message = msgBox.value.trim();
  if (!message) return;

  addMessage(message, 'user');
  memory.push({ user: message }); // store user message
  if (soundEnabled) sendSound.play();
  msgBox.value = '';

  showTyping();

  try {
    const response = await fetch('https://broken-poetry-bc28.calvin-rodecker.workers.dev/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        user_id: userId, 
        message: message,
        memory_summary: memory.map(m => m.user + (m.partner||'')).join('\n')
      })
    });

    const data = await response.json();
    hideTyping();

    if (data.ai_reply) {
      addMessage(data.ai_reply, 'partner');
      memory.push({ partner: data.ai_reply }); // store AI reply
      if (soundEnabled) sendSound.play();
    } else {
      addMessage('Error contacting Partner', 'partner');
    }

  } catch (err) {
    hideTyping();
    addMessage('Error contacting Partner: ' + err.message, 'partner');
  }
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);
msgBox.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

clearBtn.addEventListener('click', () => {
  chat.innerHTML = '';
  memory = [];
});

toggleThemeBtn.addEventListener('click', () => {
  document.body.classList.toggle('dark');
});

toggleSoundBtn.addEventListener('click', () => {
  soundEnabled = !soundEnabled;
  toggleSoundBtn.textContent = soundEnabled ? 'Toggle Sound' : 'Sound Off';
});

</script>

</body>
</html>
