<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Partner Chat</title>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
}

body {
  background: linear-gradient(135deg,#ffd1dc,#ffe4e1);
  display: flex;
  justify-content: center;
}

.container {
  width: 100%;
  max-width: 430px;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  background: #fff;
}

/* Chat area */
#chat {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: #fff;
}

/* Messages */
.message {
  display: flex;
  align-items: flex-end;
  margin-bottom: 12px;
}

.message.user { justify-content: flex-end; }
.message.partner { justify-content: flex-start; }

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  margin: 0 6px;
}

.bubble {
  max-width: 75%;
  padding: 12px 16px;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.35;
}

.user .bubble {
  background: #ff3b61;
  color: #fff;
  border-bottom-right-radius: 4px;
}

.partner .bubble {
  background: #f1f1f1;
  color: #000;
  border-bottom-left-radius: 4px;
}

/* Typing bubble */
.typing-bubble {
  width: 48px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.typing-bubble span {
  width: 6px;
  height: 6px;
  margin: 0 2px;
  background: #999;
  border-radius: 50%;
  animation: blink 1.4s infinite both;
}

.typing-bubble span:nth-child(2){animation-delay:.2s}
.typing-bubble span:nth-child(3){animation-delay:.4s}

@keyframes blink {
  0%{opacity:.2}
  20%{opacity:1}
  100%{opacity:.2}
}

/* Input bar */
#inputArea {
  padding: 10px;
  border-top: 1px solid #ddd;
  background: #fff;
}

#msg {
  width: 100%;
  height: 40px;
  border-radius: 20px;
  border: 1px solid #ccc;
  padding: 10px 14px;
  font-size: 16px;
  resize: none;
}

button {
  margin-top: 8px;
  width: 100%;
  padding: 10px;
  border-radius: 20px;
  border: none;
  background: #ff3b61;
  color: white;
  font-weight: bold;
}

/* Controls */
#controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
}

/* Color orbs */
.orbs {
  display: flex;
  gap: 8px;
}

.orb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: inset 0 0 4px rgba(255,255,255,.6);
}

.orb.pink {background:#ffd1dc}
.orb.lavender {background:#e6d9ff}
.orb.mint {background:#d4f8e8}
.orb.dark {background:#222}

.toggle {
  font-size: 13px;
  color: #0077ff;
  cursor: pointer;
}
</style>
</head>

<body>
<div class="container">
  <div id="chat"></div>

  <div id="inputArea">
    <textarea id="msg" placeholder="Message…"></textarea>
    <button onclick="send()">Send</button>

    <div id="controls">
      <div class="orbs">
        <div class="orb pink" onclick="setBG('pink')"></div>
        <div class="orb lavender" onclick="setBG('lavender')"></div>
        <div class="orb mint" onclick="setBG('mint')"></div>
        <div class="orb dark" onclick="setBG('dark')"></div>
      </div>
      <span class="toggle" onclick="clearChat()">Clear</span>
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://broken-poetry-bc28.calvin-rodecker.workers.dev/";
const userAvatar = "https://api.dicebear.com/7.x/personas/svg?seed=male";
const partnerAvatar = "https://api.dicebear.com/7.x/personas/svg?seed=female";

document.getElementById("msg").addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

function addMessage(text, sender, typing=false) {
  const chat = document.getElementById("chat");
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;

  msg.innerHTML = `
    ${sender==="partner" ? `<img class="avatar" src="${partnerAvatar}">` : ""}
    <div class="bubble ${typing?'typing-bubble':''}">
      ${typing ? '<span></span><span></span><span></span>' : text}
    </div>
    ${sender==="user" ? `<img class="avatar" src="${userAvatar}">` : ""}
  `;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
  return msg;
}

async function send() {
  const input = document.getElementById("msg");
  const message = input.value.trim();
  if (!message) return;

  addMessage(message, "user");
  input.value = "";

  const typingMsg = addMessage("", "partner", true);

  const res = await fetch(WORKER_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ message })
  });

  const data = await res.json();
  const delay = Math.random()*5000 + 2000;

  setTimeout(() => {
    typingMsg.remove();
    addMessage(data.ai_reply || "Say that again…", "partner");
  }, delay);
}

function setBG(type) {
  const bgs = {
    pink:"linear-gradient(135deg,#ffd1dc,#ffe4e1)",
    lavender:"linear-gradient(135deg,#e6d9ff,#f3e8ff)",
    mint:"linear-gradient(135deg,#d4f8e8,#e8fff8)",
    dark:"#222"
  };
  document.body.style.background = bgs[type];
}

function clearChat() {
  document.getElementById("chat").innerHTML="";
}
</script>
</body>
</html>
